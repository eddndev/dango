---
import fs from 'node:fs';
import path from 'node:path';
import sharp from 'sharp';
import DangoLogo from './DangoLogo.astro';

interface Props {
    folder?: string;
    title?: string;
    id?: string;
}

const { 
    folder = "Dango", 
    title = "DANGO", 
    id = "galeria" 
} = Astro.props;

const galleryPath = `public/images/Galerias/${folder}`;

// Estructura de nuestros items
type GalleryItem = 
    | { type: 'image', src: string, name: string, width: number, height: number, aspectRatio: number } 
    | { type: 'logo', height: number }; 

// Definimos 3 columnas explícitas
const columns: GalleryItem[][] = [[], [], []];
const columnHeights = [0, 0, 0]; 

try {
    const absolutePath = path.resolve(galleryPath);
    if (fs.existsSync(absolutePath)) {
        const files = fs.readdirSync(absolutePath);
        
        // 1. Ordenar (Natural)
        files.sort((a, b) => a.localeCompare(b, undefined, { numeric: true, sensitivity: 'base' }));

        // 2. Procesar imágenes
        const imageFiles = files.filter(file => /\.(webp|jpg|jpeg|png|gif)$/i.test(file));
        
        for (const file of imageFiles) {
            const fullPath = path.join(absolutePath, file);
            try {
                const metadata = await sharp(fullPath).metadata();
                if (metadata.width && metadata.height) {
                    const aspectRatio = metadata.height / metadata.width;
                    
                    const shortestColIndex = columnHeights.indexOf(Math.min(...columnHeights));
                    
                    columns[shortestColIndex].push({
                        type: 'image',
                        src: `/images/Galerias/${folder}/${file}`, // Ruta dinámica
                        name: file,
                        width: metadata.width,
                        height: metadata.height,
                        aspectRatio: aspectRatio
                    });
                    
                    columnHeights[shortestColIndex] += aspectRatio;
                }
            } catch (err) {
                console.error(`Error leyendo metadata de ${file}:`, err);
            }
        }

        // 4. Relleno Mágico (Leveling)
        const maxHeight = Math.max(...columnHeights);

        columnHeights.forEach((h, index) => {
            const diff = maxHeight - h;
            if (diff > 0.01) { 
                columns[index].push({
                    type: 'logo',
                    height: diff
                });
            }
        });
    }
} catch (e) {
    console.error(`Error leyendo galería:`, e);
}
---

<section id={id} class="gallery-section relative min-h-screen bg-black py-24 px-4 md:px-12">
    
    <!-- Header -->
    <div class="mb-12 text-center">
        <h2 class="font-kismis text-white text-5xl md:text-7xl tracking-widest uppercase text-transparent bg-clip-text bg-gradient-to-r from-brand-purple to-dango-pink inline-block relative z-10">
            {title}
        </h2>
        <div class="h-1 w-24 bg-brand-purple mx-auto mt-4 rounded-full"></div>
    </div>

    <!-- MASONRY EXPLÍCITO (3 Columnas Flex) -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 md:gap-8 max-w-[1600px] mx-auto items-start">
        
        {columns.map((colItems, colIndex) => (
            <div class="flex flex-col gap-4 md:gap-8 w-full">
                {colItems.map((item, itemIndex) => (
                    <div class="gallery-item relative overflow-hidden rounded-lg group w-full">
                        {item.type === 'image' ? (
                            <>
                                <img 
                                    src={item.src} 
                                    alt={item.name} 
                                    width={item.width}
                                    height={item.height}
                                    class="w-full h-auto object-cover transition-transform duration-700 group-hover:scale-105 grayscale group-hover:grayscale-0 shadow-2xl cursor-zoom-in block"
                                    loading="lazy" 
                                />
                                <div class="absolute inset-0 bg-brand-purple/20 opacity-0 group-hover:opacity-100 transition-opacity duration-500 pointer-events-none mix-blend-overlay"></div>
                            </>
                        ) : (
                            /* TARJETA DE RELLENO INTELIGENTE */
                            /* Usamos aspect-ratio style inline basado en la diferencia calculada */
                            <div 
                                style={`aspect-ratio: 1 / ${item.height};`}
                                class="w-full bg-neutral-900 flex items-center justify-center border border-white/5 group-hover:border-brand-purple/30 transition-colors duration-500 min-h-[150px]"
                            >
                                <div class="w-1/2 opacity-10 group-hover:opacity-100 transition-opacity duration-500 text-white transform group-hover:scale-110 duration-700">
                                    <DangoLogo />
                                </div>
                            </div>
                        )}
                    </div>
                ))}
            </div>
        ))}

    </div>

    <!-- LIGHTBOX MODAL (Scoped by ID) -->
    <div id={`lightbox-${id}`} class="lightbox fixed inset-0 z-[100] bg-black/95 flex items-center justify-center opacity-0 pointer-events-none transition-opacity duration-300 backdrop-blur-md">
        <button class="lightbox-close absolute top-6 right-8 text-white/50 hover:text-white text-6xl font-light transition-colors z-[101] focus:outline-none leading-none">&times;</button>
        <div class="relative w-full h-full p-4 md:p-10 flex items-center justify-center">
            <img class="lightbox-img max-w-full max-h-full object-contain shadow-2xl rounded-sm drop-shadow-[0_0_50px_rgba(139,92,246,0.3)]" src="" alt="Full view" />
        </div>
    </div>
</section>

<script>
    import { gsap } from "gsap";
    import { ScrollTrigger } from "gsap/ScrollTrigger";

    gsap.registerPlugin(ScrollTrigger);

    const initGallery = () => {
        // Inicializar todas las galerías en la página
        const galleries = document.querySelectorAll(".gallery-section");

        galleries.forEach(section => {
            // --- LIGHTBOX (Scoped) ---
            // Buscamos el lightbox específico de esta sección (hijo directo o por ID relacionado)
            // Como el script corre globalmente, buscamos el lightbox que está DENTRO de esta section
            const lightbox = section.querySelector(".lightbox") as HTMLElement;
            const lightboxImg = section.querySelector(".lightbox-img") as HTMLImageElement;
            const closeBtn = section.querySelector(".lightbox-close");
            const galleryImages = section.querySelectorAll(".gallery-item img");

            if (!lightbox || !lightboxImg) return;

            const openLightbox = (src: string) => {
                lightboxImg.src = src;
                lightbox.classList.remove("pointer-events-none");
                gsap.to(lightbox, { opacity: 1, duration: 0.3, ease: "power2.out" });
                gsap.fromTo(lightboxImg, { scale: 0.95, opacity: 0 }, { scale: 1, opacity: 1, duration: 0.4, ease: "back.out(1.2)" });
                document.body.style.overflow = "hidden";
                window.lenis?.stop();
            };

            const closeLightbox = () => {
                gsap.to(lightbox, { 
                    opacity: 0, duration: 0.3, ease: "power2.in",
                    onComplete: () => {
                        lightbox.classList.add("pointer-events-none");
                        lightboxImg.src = "";
                    }
                });
                document.body.style.overflow = "";
                window.lenis?.start();
            };

            galleryImages.forEach(img => {
                img.addEventListener("click", (e) => {
                    e.stopPropagation(); // Evitar burbujeo
                    const target = e.target as HTMLImageElement;
                    openLightbox(target.src);
                });
            });

            closeBtn?.addEventListener("click", (e) => {
                e.stopPropagation();
                closeLightbox();
            });
            
            lightbox.addEventListener("click", (e) => { 
                if (e.target === lightbox) closeLightbox(); 
            });
            
            // ESC key (global listener, but check visibility)
            document.addEventListener("keydown", (e) => { 
                if (e.key === "Escape" && !lightbox.classList.contains("pointer-events-none")) {
                    closeLightbox(); 
                }
            });
        });
    };

    document.addEventListener("astro:page-load", initGallery);
</script>

<style>
    .font-kismis { font-family: var(--font-kismis, sans-serif); }
</style>