---
import fs from 'node:fs';
import path from 'node:path';

const galleryPath = 'public/images/Galerias/Dango';
let images: string[] = [];

try {
    const absolutePath = path.resolve(galleryPath);
    if (fs.existsSync(absolutePath)) {
        const files = fs.readdirSync(absolutePath);
        images = files
            .filter(file => /\.(webp|jpg|jpeg|png|gif)$/i.test(file))
            .map(file => `/images/Galerias/Dango/${file}`);
    }
} catch (e) {
    console.error(`Error leyendo galería:`, e);
}
---

<section id="galeria" class="gallery-section relative w-full h-screen bg-black overflow-hidden">
    
    <!-- Título Fijo -->
    <div class="absolute top-[100px] left-0 z-20 bg-brand-purple px-6 py-2 rounded-r shadow-lg">
        <h2 class="font-kismis text-white text-2xl tracking-widest uppercase">DANGO</h2>
    </div>

    <!-- Contenedor del Track (Centrado verticalmente) -->
    <div class="w-full h-full flex items-center pt-[80px]"> <!-- pt-80px compensa navbar -->
        
        <!-- Track que se moverá -->
        <div class="gallery-track flex gap-4 px-[10vw] w-max"> 
            {
                images.length > 0 ? (
                    images.map((imgSrc, index) => (
                        <div class="gallery-item h-[60vh] aspect-[2/3] md:aspect-[3/4] flex-shrink-0 relative overflow-hidden rounded-sm group">
                            <img 
                                src={imgSrc} 
                                alt={`Foto ${index}`} 
                                class="w-full h-full object-cover transition-transform duration-700 group-hover:scale-110 grayscale group-hover:grayscale-0"
                                loading="eager" 
                            />
                        </div>
                    ))
                ) : (
                    <div class="text-white text-xl">Cargando Galería...</div>
                )
            }
             <!-- Buffer final -->
             <div class="w-[20vw] flex-shrink-0"></div>
        </div>

    </div>
</section>

<script>
    import { gsap } from "gsap";
    import { ScrollTrigger } from "gsap/ScrollTrigger";

    gsap.registerPlugin(ScrollTrigger);

    const initGallery = () => {
        const section = document.querySelector(".gallery-section");
        const track = document.querySelector(".gallery-track") as HTMLElement;

        if (!section || !track) return;

        // Limpiar previos
        ScrollTrigger.getAll().forEach(t => {
            if (t.trigger === section) t.kill();
        });

        // 1. Calcular ancho real del contenido
        const getScrollAmount = () => {
            return -(track.scrollWidth - window.innerWidth);
        };

        // 2. Crear animación
        const tween = gsap.to(track, {
            x: getScrollAmount,
            ease: "none",
            duration: 1 // Dummy duration, controlado por scroll
        });

        // 3. Crear Trigger
        ScrollTrigger.create({
            trigger: section,
            start: "top top",
            end: () => `+=${track.scrollWidth - window.innerWidth}`, 
            pin: true,
            animation: tween,
            scrub: 1,
            invalidateOnRefresh: true, // Recalcular si cambia tamaño ventana
            anticipatePin: 1
        });
        
        // Forzar refresco para que detecte el ancho correcto de las imágenes
        ScrollTrigger.refresh();
    };

    // Inicializar en Astro Navigation
    document.addEventListener("astro:page-load", initGallery);
    
    // Y también cuando todas las imágenes hayan cargado (CRUCIAL para cálculo de ancho)
    window.addEventListener("load", () => {
        ScrollTrigger.refresh();
    });
</script>

<style>
    /* Asegurar que el track tome el ancho de su contenido */
    .gallery-track {
        width: max-content;
    }
    
    .font-kismis {
        font-family: var(--font-kismis, sans-serif);
    }
</style>